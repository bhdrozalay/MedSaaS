# Story 1.4: Abonelik ve Ödeme Sistemi

**Story ID:** 1.4  
**Epic:** Platform Temel Altyapısı  
**Status:** Draft  
**Story Points:** 21  
**Sprint:** Sprint 3

## User Story
**As a** tenant admin  
**I want to** şirketimin abonelik planını yönetebilmek ve ödemeleri takip edebilmek  
**So that** platform kullanımımı sürdürebilir, modül ekleyebilir/çıkarabilir ve fatura süreçlerimi yönetebilirim

## Acceptance Criteria

### AC-01: Demo Period Yönetimi
- [ ] Yeni kayıtlı tenant'lar otomatik 15 gün demo periyodu alır
- [ ] Demo süresince tüm modüllere tam erişim sağlanır
- [ ] Demo bitimine 3 gün kala e-posta uyarısı gönderilir
- [ ] Demo bittikten sonra sadece okuma erişimi kalır
- [ ] Admin demo süresini manuel olarak uzatabilir (max 30 gün)

### AC-02: Abonelik Planı Seçimi
- [ ] Demo bitiminde ödeme sayfasına yönlendirme
- [ ] Abonelik planları görüntülenir:
  - **Temel Plan**: $20/ay/çalışan (çekirdek modüller)
  - **Profesyonel Plan**: $35/ay/çalışan (gelişmiş modüller)
  - **Enterprise Plan**: $50/ay/çalışan (tüm modüller + AI)
- [ ] Çalışan sayısı seçimi (5-500 arası)
- [ ] Kurulum ücreti $500 otomatik eklenir
- [ ] Yıllık ödeme seçeneklerinde %10 indirim uygulanır

### AC-03: Ödeme Entegrasyonu
- [ ] Stripe payment gateway entegrasyonu
- [ ] Kredi kartı ile ödeme (Visa, MasterCard, American Express)
- [ ] Güvenli 3D Secure doğrulama
- [ ] Ödeme başarılı olduğunda hesap otomatik aktifleşir
- [ ] Ödeme başarısız olursa hata mesajı ve retry seçeneği
- [ ] Fatura otomatik PDF olarak oluşturulur

### AC-04: Fatura ve Muhasebe
- [ ] Her ödeme için otomatik fatura oluşturur
- [ ] Fatura bilgileri:
  - Şirket bilgileri (vergi dairesi, vergi no)
  - Hizmet detayları (plan, kullanıcı sayısı, dönem)
  - Vergi hesaplaması (%20 KDV)
  - Toplam tutar ve ödeme tarihi
- [ ] Fatura PDF formatında e-posta ile gönderilir
- [ ] Fatura geçmişi admin panelinde görüntülenir
- [ ] Muhasebe entegrasyonu için XML/JSON export

### AC-05: Otomatik Yenileme Sistemi
- [ ] Aylık abonelikler otomatik yenilenir
- [ ] Yenileme 5 gün öncesinden e-posta ile bildirilir
- [ ] Ödeme başarısız olursa:
  - 3 gün grace period verilir
  - Her gün hatırlatma e-postası gönderilir
  - 3. gün sonra hesap suspend edilir
- [ ] Suspend durumda sadece okuma erişimi
- [ ] Ödeme yapılınca hesap otomatik reaktive edilir

### AC-06: Plan Değişikliği ve Modül Yönetimi
- [ ] Admin mevcut planını upgrade/downgrade edebilir
- [ ] Çalışan sayısı artırım/azaltım (aylık ortalama üzerinden ücretlendirme)
- [ ] Ek modül satın alma:
  - AI Modülü: +$10/ay/kullanıcı
  - Advanced Reporting: +$5/ay/kullanıcı
  - API Access: +$15/ay (unlimited)
  - WhatsApp Entegrasyonu: +$8/ay/kullanıcı
- [ ] Plan değişikliği sonraki fatura döngüsünde geçerli
- [ ] Prorated billing (kısa dönem hesaplama)

### AC-07: Abonelik İptali ve Hesap Donduruması
- [ ] Admin aboneliğini iptal edebilir (30 gün önceden)
- [ ] İptal edilen hesap dönem sonuna kadar aktif kalır
- [ ] İptal sonrası veri export seçeneği (90 gün süreyle)
- [ ] Geçici hesap donduruması (max 6 ay):
  - Dondurulan hesap için ücret alınmaz
  - Veri korunur ancak erişim engellenir
  - İstediği zaman reaktive edilebilir
- [ ] Hesap silme talebi (GDPR/KVKK uyumlu)

### AC-08: Admin Onay Sistemi
- [ ] Süper admin yeni abonelikleri manual onaylayabilir
- [ ] Onay bekleyen hesaplar "pending approval" durumunda
- [ ] Onaylanmayan hesaplar demo süresi dolunca suspend edilir
- [ ] Admin onay/red sebeplerini girebilir
- [ ] Bulk approval/rejection özelliği

### AC-09: Ödeme Raporları ve Analytics
- [ ] Aylık gelir raporları
- [ ] Abonelik churn rate (iptal oranı)
- [ ] Plan dağılımı analytics
- [ ] Ödeme başarı oranları
- [ ] Customer lifetime value (CLV) hesaplama
- [ ] Revenue forecasting (gelir projeksiyonu)

### AC-10: Multi-Currency ve Lokalizasyon
- [ ] Türk Lirası (TRY) temel para birimi
- [ ] USD ve EUR seçenekleri
- [ ] Güncel döviz kurları entegrasyonu (TCMB/ECB)
- [ ] KDV oranı ülke bazında otomatik (TR: %20, EU: değişken)
- [ ] Fatura dil seçeneği (TR/EN)

### AC-11: Güvenlik ve Compliance
- [ ] PCI DSS Level 1 compliance (Stripe üzerinden)
- [ ] Ödeme bilgileri tokenize edilir (kart bilgisi saklanmaz)
- [ ] SSL/TLS şifreleme (minimum TLS 1.3)
- [ ] GDPR/KVKK uyumlu veri işleme
- [ ] SOX compliance (finansal raporlama)
- [ ] Fraud detection (şüpheli işlem tespiti)

### AC-12: Mobil Ödeme Deneyimi
- [ ] Responsive ödeme sayfaları
- [ ] Apple Pay ve Google Pay entegrasyonu
- [ ] Mobil optimized checkout flow
- [ ] Touch ID/Face ID ile ödeme onayı (native app)
- [ ] Push notification ödeme bildirimleri

## Technical Requirements

### Database Schema
```sql
-- Subscription plans table
CREATE TABLE subscription_plans (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL,
    monthly_price_per_user DECIMAL(10,2),
    yearly_price_per_user DECIMAL(10,2),
    max_users INTEGER,
    features JSONB,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Tenant subscriptions table
CREATE TABLE tenant_subscriptions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID REFERENCES tenants(id),
    plan_id UUID REFERENCES subscription_plans(id),
    status VARCHAR(50) DEFAULT 'demo', -- demo, active, suspended, cancelled
    user_count INTEGER NOT NULL,
    current_period_start TIMESTAMP,
    current_period_end TIMESTAMP,
    demo_end_date TIMESTAMP,
    cancel_at_period_end BOOLEAN DEFAULT false,
    stripe_subscription_id VARCHAR(255),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Payment history table
CREATE TABLE payments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID REFERENCES tenants(id),
    subscription_id UUID REFERENCES tenant_subscriptions(id),
    stripe_payment_intent_id VARCHAR(255),
    amount DECIMAL(10,2) NOT NULL,
    currency VARCHAR(3) DEFAULT 'TRY',
    status VARCHAR(50), -- pending, succeeded, failed, refunded
    payment_method VARCHAR(100),
    invoice_url TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Invoices table
CREATE TABLE invoices (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID REFERENCES tenants(id),
    payment_id UUID REFERENCES payments(id),
    invoice_number VARCHAR(100) UNIQUE,
    amount_subtotal DECIMAL(10,2),
    amount_tax DECIMAL(10,2),
    amount_total DECIMAL(10,2),
    currency VARCHAR(3),
    invoice_pdf_url TEXT,
    status VARCHAR(50) DEFAULT 'draft', -- draft, sent, paid, void
    due_date TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Addon modules table
CREATE TABLE addon_modules (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL,
    description TEXT,
    monthly_price_per_user DECIMAL(10,2),
    is_per_user BOOLEAN DEFAULT true,
    features JSONB,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Tenant addon subscriptions
CREATE TABLE tenant_addon_subscriptions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID REFERENCES tenants(id),
    addon_id UUID REFERENCES addon_modules(id),
    quantity INTEGER DEFAULT 1,
    status VARCHAR(50) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT NOW()
);
```

### API Endpoints
- `GET /api/billing/plans` - Abonelik planları listesi
- `POST /api/billing/checkout` - Ödeme session oluştur
- `GET /api/billing/subscription` - Mevcut abonelik bilgisi
- `PUT /api/billing/subscription` - Plan değişikliği
- `POST /api/billing/subscription/cancel` - Abonelik iptali
- `GET /api/billing/invoices` - Fatura geçmişi
- `POST /api/billing/addons` - Addon modül ekle/çıkar
- `GET /api/billing/usage` - Kullanım analytics

### Stripe Webhook Events
- `invoice.payment_succeeded`
- `invoice.payment_failed`
- `customer.subscription.updated`
- `customer.subscription.deleted`
- `checkout.session.completed`

### Frontend Components
- `BillingDashboard.tsx`
- `PlanSelectionModal.tsx`
- `PaymentCheckout.tsx`
- `InvoiceHistory.tsx`
- `AddonManagement.tsx`
- `UsageAnalytics.tsx`
- `SubscriptionSettings.tsx`

### Third-party Integrations
- **Stripe**: Payment processing, subscription management
- **TCMB API**: Döviz kurları
- **PDF Generator**: Fatura PDF oluşturma
- **Email Service**: SendGrid/AWS SES
- **Accounting**: Fatura XML export (e-Fatura/e-Arşiv)

## Definition of Done
- [ ] Tüm AC'ler test edildi ve geçti
- [ ] Stripe webhook testleri tamamlandı
- [ ] PCI DSS security audit yapıldı
- [ ] Payment flow load testing (1000+ concurrent users)
- [ ] Multi-currency testing completed
- [ ] Invoice PDF generation tested
- [ ] Email notification system tested
- [ ] Refund and cancellation flows tested
- [ ] Code coverage > %95 (critical payment flows)

## Dependencies
- Story 1.1, 1.2, 1.3 tamamlanmış olmalı
- Stripe account setup (production keys)
- SSL certificate (payment security)
- Email service configuration
- PDF generation service
- Bank account setup (revenue collection)

## Risk & Mitigation
- **Risk:** Payment gateway downtime
- **Mitigation:** Fallback payment methods + status monitoring

- **Risk:** Currency fluctuation (multi-currency)
- **Mitigation:** Daily rate updates + hedging strategy

- **Risk:** Failed recurring payments
- **Mitigation:** Multiple retry attempts + grace period

- **Risk:** Fraud/Chargeback
- **Mitigation:** Stripe Radar + manual review process

## Notes
Bu story, platformun monetizasyon temelini oluşturur. Güvenilir ödeme sistemi, düzgün faturalama ve esnek abonelik yönetimi müşteri memnuniyeti için kritiktir. Özellikle Türk vergi sistemi ve KOBİ ihtiyaçlarına uygun olması önemli.

**Önemli:** Ödeme sistemlerinde hata toleransı çok düşük olmalı. Tüm edge case'ler düşünülmeli ve comprehensive testing yapılmalı.