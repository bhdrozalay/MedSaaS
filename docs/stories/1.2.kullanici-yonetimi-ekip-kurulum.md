# Story 1.2: Kullanıcı Yönetimi ve Ekip Kurulumu

**Story ID:** 1.2  
**Epic:** Platform Temel Altyapısı  
**Status:** Draft  
**Story Points:** 13  
**Sprint:** Sprint 2

## User Story
**As a** tenant admin  
**I want to** şirketim içindeki departmanları, rolleri ve çalışanları yönetebilmek  
**So that** her departman kendi iş süreçlerine uygun modüllere erişebilsin ve güvenli çalışabilsin

## Acceptance Criteria

### AC-01: Kullanıcı Davetiye Sistemi
- [ ] Tenant admin "Kullanıcı Ekle" butonuna tıklayabilir
- [ ] Davetiye formu şu alanları içerir:
  - Ad Soyad (zorunlu)
  - E-posta (zorunlu, unique)
  - Telefon (opsiyonel)
  - Departman (dropdown)
  - Rol (dropdown, departmana göre filtreli)
- [ ] Sistem davetiye e-postası gönderir
- [ ] Davetiye linki 48 saat geçerlidir
- [ ] Davetiyeli kullanıcı şifre oluşturarak hesabını aktif eder

### AC-02: Departman Tabanlı Rol Sistemi
- [ ] Sistem şu departmanları destekler:
  - **Satış** → Ziyaret Takibi, Tender Yönetimi modülleri
  - **Depo** → Envanter Yönetimi, Sipariş modülleri
  - **Muhasebe** → Finansal Raporlar, Fatura modülleri  
  - **Yönetici** → Tüm modüllere erişim
- [ ] Her departmanın varsayılan rol yetkileri tanımlı
- [ ] Roller modül bazında izin matrisi içerir (CRUD)

### AC-03: Kullanıcı Profil Yönetimi
- [ ] Kullanıcı kendi profil bilgilerini güncelleyebilir
- [ ] Profil fotoğrafı yükleyebilir (mobilde kamera entegrasyonu)
- [ ] Kişisel bilgileri (ad, telefon, e-posta) değiştirebilir
- [ ] Şifre değiştirme özelliği mevcuttur
- [ ] İki faktörlü doğrulama (2FA) etkinleştirebilir

### AC-04: Kullanıcı Listesi ve Yönetim
- [ ] Tüm kullanıcılar liste halinde görüntülenir (< 2 saniye)
- [ ] Liste filtreleme özellikleri:
  - Departmana göre filtreleme
  - Role göre filtreleme
  - Aktif/Pasif duruma göre
  - Son giriş tarihine göre sıralama
- [ ] Kullanıcı arama özelliği (ad, e-posta)
- [ ] Sayfalama (25 kullanıcı/sayfa)

### AC-05: Kullanıcı Durum Yönetimi
- [ ] Admin kullanıcıyı "aktif/pasif" yapabilir
- [ ] Pasif kullanıcılar sisteme giriş yapamaz
- [ ] Kullanıcı silme işlemi (soft delete)
- [ ] Silinen kullanıcılar 90 gün süreyle kurtarılabilir
- [ ] Son giriş tarihi ve IP adresi loglanır

### AC-06: Özel İş Departmanı Rolleri Oluşturma
- [ ] Tenant admin özel departman rolleri tanımlayabilir
- [ ] Rol oluştururken hangi modüllere erişim vereceğini seçebilir
- [ ] Modül bazında yetki seviyelerini ayarlayabilir (Okuma/Yazma/Düzenleme/Silme)
- [ ] Özel roller sadece kendi tenant'ı içinde geçerlidir
- [ ] Rol şablonları kaydetme özelliği

### AC-07: Departman Bazlı Modül Erişim Kontrolü  
- [ ] **Satış Departmanı:**
  - Ziyaret Takibi modülü (tam erişim)
  - Tender Yönetimi modülü (tam erişim)
  - Müşteri CRM modülü (okuma/yazma)
  - Raporlama (sadece satış raporları)
- [ ] **Depo Departmanı:**
  - Envanter Yönetimi (tam erişim)
  - Sipariş İşlemleri (okuma/güncelleme)
  - Tedarikçi Yönetimi (okuma)
- [ ] **Muhasebe Departmanı:**
  - Finansal Raporlar (tam erişim)
  - Fatura ve Ödeme İşlemleri (tam erişim)
  - Bütçe Planlama (tam erişim)
  - Vergi ve Mevzuat Takibi (tam erişim)

### AC-08: Güvenlik ve Audit
- [ ] Tüm kullanıcı işlemleri audit log'da tutulur
- [ ] Şifre politikası uygulanır (min 8 karakter, özel karakter)
- [ ] Başarısız giriş denemeleri takip edilir (5 deneme = hesap kilidi)
- [ ] GDPR/KVKK uyumluluğu (veri saklama ve silme)
- [ ] Tenant seviyesinde veri izolasyonu garanti edilir

### AC-09: Mobil Uyumluluk
- [ ] Kullanıcı listesi mobil cihazlarda optimum görünür
- [ ] Mobil cihazda kamera ile profil fotoğrafı çekebilir
- [ ] Touch-friendly kullanıcı arayüzü
- [ ] Offline durumda temel bilgiler cache'den görüntülenebilir

### AC-10: Bildirim Sistemi
- [ ] Yeni kullanıcı eklendi bildirimi (admin'e)
- [ ] Kullanıcı profil güncelleme bildirimi
- [ ] Güvenlik uyarıları (şüpheli giriş vs.)
- [ ] E-posta ve in-app bildirim seçenekleri

## Technical Requirements

### Database Schema Extensions
```sql
-- Departments table
CREATE TABLE departments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID REFERENCES tenants(id),
    name VARCHAR(100) NOT NULL,
    description TEXT,
    is_custom BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Roles table  
CREATE TABLE roles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID REFERENCES tenants(id),
    department_id UUID REFERENCES departments(id),
    name VARCHAR(100) NOT NULL,
    permissions JSONB, -- Module permissions
    is_custom BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Users table extension
ALTER TABLE users ADD COLUMN department_id UUID REFERENCES departments(id);
ALTER TABLE users ADD COLUMN role_id UUID REFERENCES roles(id);
ALTER TABLE users ADD COLUMN last_login TIMESTAMP;
ALTER TABLE users ADD COLUMN failed_login_attempts INTEGER DEFAULT 0;
ALTER TABLE users ADD COLUMN account_locked_until TIMESTAMP NULL;

-- Audit log table
CREATE TABLE user_audit_log (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID REFERENCES tenants(id),
    user_id UUID REFERENCES users(id),
    action VARCHAR(100),
    details JSONB,
    ip_address INET,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### API Endpoints
- `POST /api/users/invite` - Kullanıcı davetiye gönder
- `GET /api/users` - Kullanıcı listesi (filtreleme/arama)
- `PUT /api/users/{id}/status` - Kullanıcı durum güncelle
- `POST /api/departments` - Özel departman oluştur
- `POST /api/roles` - Özel rol oluştur
- `GET /api/users/{id}/audit` - Kullanıcı audit log

### Frontend Components
- `UserManagementDashboard.tsx`
- `InviteUserModal.tsx`
- `UserRoleMatrix.tsx`
- `DepartmentRoleSelector.tsx`
- `UserProfileEditor.tsx`

### Mobile Specific Features
- Camera integration for profile photos
- Biometric authentication (fingerprint/face ID)
- Responsive user management interface

## Definition of Done
- [ ] Tüm AC'ler test edildi ve geçti
- [ ] Security penetration testing tamamlandı
- [ ] GDPR/KVKK compliance audit yapıldı
- [ ] Performance testing (2000+ user simulation)
- [ ] Mobile responsiveness all devices tested
- [ ] API documentation güncellendi
- [ ] E2E testler automated
- [ ] Code coverage > %90

## Dependencies
- Story 1.1 tamamlanmış olmalı (tenant altyapısı)
- NextAuth.js role-based auth extension
- File upload service (profile photos)
- Email service (invitations)

## Risk & Mitigation
- **Risk:** Performans sorunu (çok kullanıcılı tenant'lar)
- **Mitigation:** Database indexing + pagination + caching

- **Risk:** Security açıkları (rol yetkilendirme)
- **Mitigation:** Extensive security testing + audit logging

## Notes
Bu story, platformun güvenlik ve kullanıcı yönetim temelini oluşturur. Bütün modüllerin çalışabilmesi için kritik rol tabanlı yetkilendirme altyapısını sağlar. Özellikle çok departmanlı şirketler için esneklik sunması önemli.